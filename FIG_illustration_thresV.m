% FIG_illustration_thresV plots Figure 4a and 4b.
% Note that there is stochasticity in the code, so you won't get the exact
% same figures.

%% Prepare the simulated data (generated by Prop-V and fit using Prop)
clear; close all;

% load parameters fit by PropV models
subnum = 154;
load(['fittingresult/PropV_sub' num2str(subnum) '.mat']);
pV = p_min;
load(['fittingresult/Prop_sub' num2str(subnum) '.mat']);
pFini = p_min;

N_trials = 5;
eta = randn(1,N_trials)*pV(3);

% generate some simulated data using the Prop-V model
[simu_data,~] = simulate_data(5,pV,30);
simu_data = fun_generatemoreinfotask(simu_data);

% fit these simulated data to Prop
simu_data = simu_data(simu_data(:,3)>1,:); % remove the first choices
thres = @(pF)(simu_data(:,2)-simu_data(:,3)+1)./simu_data(:,2) + pF(2);
thres_bounded = @(pF)thres(pF).*(thres(pF)>=1&thres(pF)<=5) + 1*(thres(pF)<1) + 5*(thres(pF)>5);
DV = @(pF)pF(1)*(thres_bounded(pF) - simu_data(:,7));
llh = @(pF)-sum(log(1./(1+exp(-pF(3)*DV(pF))).*(simu_data(:,5)==1) + (1-1./(1+exp(-pF(3)*DV(pF)))).*(simu_data(:,5)==0)));
pF = fminunc(llh,pFini);

%% plot the thresholds
figh = 100*3;
figw = 120*3;
figure('position',[100 100 figw figh]); hold on;
defcolor = get(0,'DefaultAxesColorOrder');

prop_all = 0:0.01:1;

% PropV model
for i_trial = 1:N_trials
    plot(prop_all,pV(1)*prop_all+pV(2)+eta(i_trial),'color',defcolor(i_trial,:),'LineWidth',2);
end

% PropF model
plot(prop_all,pF(1)*prop_all+pF(2),'--','color',[0.5 0.5 0.5],'LineWidth',2);
set(gca,'tickdir','out');
set(gca,'box','off');
set(gca,'LineWidth',1);
ylim([1 5]); xlim([0 1])
set(gca,'Xdir','reverse')
set(gca,'xtick',0:0.1:1); set(gca,'ytick',1:5);
set(gca,'xticklabel',{'0','','','','','0.5','','','','','1'})
set(gca,'yticklabel',{'1','2','3','4','5'});
xlabel('Proportion of days left'); ylabel('threshold');
set(gca,'fontsize',20);
% legend({' Trial 1',' Trial 2',' Trial 3',' Trial 4',' Trial 5',' All trials'}); legend boxoff;

%% plot the psychometrics curve
figh = 100*3;
figw = 120*3;
figure('position',[100 100 figw figh]); hold on;
defcolor = get(0,'DefaultAxesColorOrder');

% PropV model
for i_trial = 1:N_trials
    DV_all = -1.5:0.01:1.5;
    plot(DV_all,1./(1+exp(-pV(4)*(DV_all+eta(i_trial)))),'color',defcolor(i_trial,:),'LineWidth',2);
end
for i_trial = 1:N_trials
    data_trial = simu_data(simu_data(:,1) == i_trial,:); % select data for the current trial
    data_trial = data_trial(data_trial(:,3)>1,:); % remove the first choices
    thresF = pV(1)*(data_trial(:,2)-data_trial(:,3)+1)./data_trial(:,2) + pV(2);
    DV = thresF - data_trial(:,7);
    scatter(DV,data_trial(:,5),50,defcolor(i_trial,:),'filled','MarkerFaceAlpha',0.3,'MarkerEdgeColor',defcolor(i_trial,:));
end

% PropF model
DV_all = -1.5:0.01:1.5;
prediction = 1./(1+exp(-pF(3)*DV_all));
plot(DV_all,prediction,'--','color',[0.5 0.5 0.5],'LineWidth',2);

set(gca,'tickdir','out');
set(gca,'box','off');
set(gca,'LineWidth',1);
ylim([-0.02 1.02]); xlim([-1.5 1.5])
set(gca,'xtick',-1:1:1); set(gca,'ytick',0:0.5:1);
set(gca,'yticklabel',{'0','0.5','1'});
xlabel('Mean threshold - r*'); ylabel('P(explore)');
set(gca,'fontsize',20);
