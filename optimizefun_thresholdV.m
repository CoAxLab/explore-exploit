function minusllh = optimizefun_thresholdV(model,pars,actions,muvalue,daysleft,totaldays)
% optimizefun_thresholdV specifies the Num-V and Prop-V model used in
% model fitting (modelfitting_thresholdV.m)

Ntrials = sum(daysleft == 1);

loglik = zeros(1,Ntrials);
i = 1;

[k,b,sigma,beta] = deal(pars(1),pars(2),exp(pars(3)),exp(pars(4)));

deta = sigma/300;
eta = -6*sigma:deta:6*sigma; % row vector
pmf = normpdf(eta,0,sigma)*deta;

for itrial = 1:Ntrials
    % pull out the data for that trial
    trial_length = totaldays(i);
    trial_rstar = [nan;muvalue(i:i+trial_length-2)]; % column vector
    trial_action = [1;actions(i:i+trial_length-2)];
    
    switch model
        case 4 % threshold: linear on number of days left
            thresholdfix = (k*(trial_length:-1:1) + b)';
        case 5 % threshold: linear on proportion of days left
            thresholdfix = (k*(trial_length:-1:1)/trial_length + b)'; % column vector
    end
    
    threshold = thresholdfix + eta;
    threshold(threshold>5) = 5;
    threshold(threshold<1) = 1;
    
    % numerically integrate over eta
    pexplore_eta = 1./(1+exp(-beta*(threshold - trial_rstar))); % this should give a trial_length*Neta matrix
    pexplore_eta(1,:) = 1; % first action is surely exploration
    loglik(itrial) = log(sum(prod(pexplore_eta.*(repmat(trial_action,1,length(eta))==1) + (1-pexplore_eta).*(repmat(trial_action,1,length(eta))==0),1).*pmf));
    
    i = i + trial_length - 1;
end

minusllh = - sum(loglik);

end