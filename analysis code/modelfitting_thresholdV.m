function modelfitting_thresholdV(subnum,model)
% modelfitting_thresholdV runs the fitting of the Num-V and Prop-V models
% using fminunc.
%
% USAGE: modelfitting_thresholdV(subnum,model)

Npar = 4;

% initialize parameters
sptotalnum = 100;
sppars0 = rand(Npar,sptotalnum);
switch model
    case 4
        sppars0(1,:) = 0.2*sppars0(1,:); % k
        sppars0(2,:) = sppars0(2,:) + 2.5; % b
    case 5
        sppars0(1,:) = sppars0(1,:); % k
        sppars0(2,:) = sppars0(2,:) + 2.5; % b
end
sppars0(end-1,:) = - sppars0(end-1,:) - 1; % log(sigma)
sppars0(end,:) = sppars0(end,:) + 1; % log(beta)

pars = nan(Npar,sptotalnum); minusllh = nan(1,sptotalnum); exitflag = nan(1,sptotalnum);

numnotmature = 0;

% load data to be fit
load(['data_extracted/extracted_sub' num2str(subnum) '.mat']);

for spnum = 1:sptotalnum
    spnum
    pars0 = sppars0(:,spnum);    
        
    % options for fmincon
    options.display = 'iter';
    options.MaxFunEvals = 10000;
    options.MaxIterations = 1000;
    options.Algorithm = 'quasi-newton';
    
    fun = @(pars)optimizefun_thresholdV(model,pars,actions,muvalue,daysleft,totaldays);
    [pars(:,spnum),minusllh(spnum),exitflag(spnum)] = fminunc(fun,pars0,options);
    
    % change it back to original scale
    pars(end-1:end,spnum) = exp(pars(end-1:end,spnum));
    
    if exitflag(spnum) == 0
        numnotmature = numnotmature+1;
    end
end

[minvalue,minind] = min(minusllh);
p_min = pars(:,minind)';
minusloglik_min = minvalue;

fittingmethod = ['fminunc_logscale_spnum' num2str(sptotalnum)];
save(['fittingresult/' fun_modelnum2name(model) '_sub' num2str(subnum) '.mat'],'p_min','minusloglik_min','fittingmethod');
save(['fittingresult/' fun_modelnum2name(model) '_sub' num2str(subnum) '_all.mat'],'pars','minusllh','exitflag','numnotmature','fittingmethod');

end